<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand-Sync: PENERIMA STABIL</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #000; color: white; text-align: center; margin: 0; font-family: sans-serif; overflow: hidden; }
        #v_in { display: none; }
        /* Kamera tetap terlihat sebagai latar belakang */
        #canvas_out { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; transform: scaleX(-1); }
        
        /* Layar saat file terbuka */
        #preview-layer { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; background: rgba(0,0,0,0.9); z-index: 100; 
            flex-direction: column; justify-content: center; align-items: center; 
        }
        #render-box { max-width: 90%; max-height: 70%; border: 4px solid #00ff00; border-radius: 15px; box-shadow: 0 0 20px #00ff00; }
        
        .ui { position: relative; z-index: 10; padding-top: 20px; pointer-events: none; }
        .btn-start { pointer-events: auto; padding: 20px; font-size: 1.2em; background: #58a6ff; border: none; color: white; border-radius: 10px; margin-top: 40%; }
        .btn-close { pointer-events: auto; margin-top: 20px; padding: 10px 30px; background: #ff4444; border: none; color: white; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <canvas id="canvas_out"></canvas>
    <video id="v_in" playsinline autoplay></video>

    <button id="start-btn" class="btn-start">KLIK UNTUK AKTIFKAN KAMERA</button>

    <div id="preview-layer">
        <div id="media-content"></div>
        <button class="btn-close" onclick="tutupPreview()">TUTUP & LANJUT</button>
    </div>

    <div class="ui">
        <div style="background:rgba(0,0,0,0.6); padding:10px; display:inline-block; border-radius:10px; border: 1px solid #333;">
            ID HP: <b id="my-id" style="color:#58a6ff;">...</b><br>
            <span id="msg">Menunggu Aktivasi...</span>
        </div>
    </div>

    <script>
        const msg = document.getElementById('msg');
        const previewLayer = document.getElementById('preview-layer');
        const mediaContent = document.getElementById('media-content');
        const startBtn = document.getElementById('start-btn');
        const canvasElement = document.getElementById('canvas_out');
        const canvasCtx = canvasElement.getContext('2d');
        
        let peer = new Peer(), pending = null, cameraActive = false;

        // Inisialisasi PeerJS
        peer.on('open', id => document.getElementById('my-id').innerText = id);
        peer.on('connection', c => {
            c.on('data', d => { 
                pending = d; 
                msg.innerText = "ADA FILE! KEPAL TANGAN!"; 
                msg.style.color = "#00ff00";
            });
        });

        // Inisialisasi MediaPipe Hands
        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5});

        hands.onResults(res => {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(res.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                const lm = res.multiHandLandmarks[0];
                drawConnectors(canvasCtx, lm, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
                
                // Deteksi Mengepal
                const isFist = lm[8].y > lm[6].y && lm[12].y > lm[10].y;
                if (isFist && pending) {
                    bukaFileOtomatis(pending);
                    pending = null;
                }
            }
            canvasCtx.restore();
        });

        function bukaFileOtomatis(d) {
            const blob = new Blob([d.file], { type: d.type || 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            mediaContent.innerHTML = '';
            
            // Tentukan cara menampilkan berdasarkan tipe
            if (d.type && d.type.startsWith('image/')) {
                const img = new Image(); img.src = url; img.id = 'render-box';
                mediaContent.appendChild(img);
            } else if (d.type && d.type.startsWith('video/')) {
                const vid = document.createElement('video'); vid.src = url; vid.id = 'render-box';
                vid.autoplay = true; vid.controls = true;
                mediaContent.appendChild(vid);
            } else {
                // Untuk file lain, tetap download manual
                const a = document.createElement('a'); a.href = url; a.download = d.name; a.click();
                msg.innerText = "Bukan gambar/video. Cek folder Download.";
                return;
            }
            previewLayer.style.display = 'flex';
        }

        function tutupPreview() {
            previewLayer.style.display = 'none';
            msg.innerText = "Siap menerima lagi...";
            msg.style.color = "white";
        }

        // Jalankan Kamera hanya setelah tombol di-klik
        startBtn.onclick = () => {
            startBtn.style.display = 'none';
            const camera = new Camera(document.getElementById('v_in'), {
                onFrame: async () => { await hands.send({image: document.getElementById('v_in')}); },
                width: 640, height: 480
            });
            camera.start();
            msg.innerText = "Kamera Aktif. Menunggu Lemparan...";
        };
    </script>
</body>
</html>
