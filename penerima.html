<!DOCTYPE html>
<html>
<head>
    <title>Penerima - Hand Capture</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0d1117; color: white; text-align: center; font-family: sans-serif; }
        #canvas_output { width: 100%; border-radius: 20px; }
        .badge { background: #161b22; padding: 15px; border-radius: 10px; margin: 20px; display: inline-block; }
    </style>
</head>
<body>
    <div class="badge">ID HP: <b id="my-id">...</b></div>
    <p id="msg">Menunggu lemparan...</p>
    <canvas id="canvas_output" width="480" height="640"></canvas>
    <video id="input_video" style="display:none"></video>

    <script>
        const log = document.getElementById('msg');
        let peer = new Peer();
        let pending = null;

        peer.on('open', id => document.getElementById('my-id').innerText = id);
        peer.on('connection', c => {
            log.innerText = "Terhubung!";
            c.on('data', data => { pending = data; log.innerText = "ADA FILE! TANGKAP!"; });
        });

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.5 });

        hands.onResults((results) => {
            const ctx = document.getElementById('canvas_output').getContext('2d');
            ctx.clearRect(0,0,480,640);
            ctx.drawImage(results.image, 0, 0, 480, 640);
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                const isFist = lm[8].y > lm[6].y && lm[12].y > lm[10].y;
                if (isFist && pending) {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(new Blob([pending.file]));
                    a.download = pending.name;
                    a.click();
                    pending = null;
                    log.innerText = "BERHASIL DITANGKAP!";
                }
            }
        });

        new Camera(document.getElementById('input_video'), {
            onFrame: async () => { await hands.send({image: document.getElementById('input_video')}); },
            width: 480, height: 640
        }).start();
    </script>
</body>
</html>
