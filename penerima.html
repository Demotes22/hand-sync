<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand-Sync: PENERIMA</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #000; color: white; text-align: center; margin: 0; overflow: hidden; font-family: sans-serif; }
        #canvas_out { position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.3; z-index: 1; transform: scaleX(-1); }
        #preview { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; background: #000; z-index: 100; justify-content: center; align-items: center; flex-direction: column; }
        #render { max-width: 95%; max-height: 80%; border: 3px solid #00ff00; border-radius: 10px; }
        .ui { position: relative; z-index: 10; padding-top: 40px; }
        .close-btn { margin-top: 20px; padding: 10px 20px; background: #ff4444; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>
    <canvas id="canvas_out"></canvas>
    <video id="v_in" style="display:none" playsinline autoplay></video>

    <div id="preview">
        <div id="box"></div>
        <button class="close-btn" onclick="tutup()">TUTUP X</button>
    </div>

    <div class="ui">
        <div style="background:rgba(0,0,0,0.7); padding:10px; display:inline-block; border-radius:8px;">
            ID HP: <b id="my-id" style="color:#58a6ff;">...</b><br>
            <span id="msg">Klik layar & tunggu AI...</span>
        </div>
    </div>

    <script>
        const msg = document.getElementById('msg');
        const box = document.getElementById('box');
        const preview = document.getElementById('preview');
        let peer = new Peer(), pending = null;

        document.body.onclick = () => { msg.innerText = "Sistem Aktif. Menunggu Lemparan..."; };
        peer.on('open', id => document.getElementById('my-id').innerText = id);
        
        peer.on('connection', c => {
            c.on('data', d => { 
                pending = d; 
                msg.innerText = "FILE MASUK! KEPAL TANGAN UNTUK BUKA!"; 
                if(navigator.vibrate) navigator.vibrate(200);
            });
        });

        function buka(d) {
            const blob = new Blob([d.file], { type: d.type || 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            box.innerHTML = '';
            
            if (d.type && d.type.startsWith('image/')) {
                const img = new Image(); img.src = url; img.id = 'render'; box.appendChild(img);
            } else if (d.type && d.type.startsWith('video/')) {
                const vid = document.createElement('video'); vid.src = url; vid.id = 'render'; vid.autoplay = true; vid.controls = true; box.appendChild(vid);
            } else {
                const a = document.createElement('a'); a.href = url; a.download = d.name; a.click();
                msg.innerText = "File terdownload!"; return;
            }
            preview.style.display = 'flex';
        }

        function tutup() { preview.style.display = 'none'; pending = null; msg.innerText = "Siap menerima lagi..."; }

        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({maxNumHands: 1, minDetectionConfidence: 0.5});
        hands.onResults(res => {
            const ctx = document.getElementById('canvas_out').getContext('2d');
            document.getElementById('canvas_out').width = window.innerWidth;
            document.getElementById('canvas_out').height = window.innerHeight;
            ctx.drawImage(res.image, 0, 0, window.innerWidth, window.innerHeight);
            if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                const lm = res.multiHandLandmarks[0];
                drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
                if (lm[8].y > lm[6].y && lm[12].y > lm[10].y && pending) buka(pending);
            }
        });

        new Camera(document.getElementById('v_in'), {
            onFrame: async () => { await hands.send({image: document.getElementById('v_in')}); },
            width: 480, height: 640
        }).start();
    </script>
</body>
</html>
