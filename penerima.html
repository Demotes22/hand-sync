<!DOCTYPE html>
<html>
<head>
    <title>Penerima - Ultra Stable</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #000; color: white; text-align: center; margin: 0; overflow: hidden; font-family: sans-serif; }
        video, canvas { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; transform: scaleX(-1); }
        canvas { z-index: 2; pointer-events: none; }
        #ui { position: relative; z-index: 10; margin-top: 50px; background: rgba(0,0,0,0.7); padding: 20px; display: inline-block; border-radius: 15px; }
        #start-btn { padding: 20px; font-size: 1.2em; background: #28a745; color: white; border: none; border-radius: 10px; cursor: pointer; }
        #view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; background: #000; z-index: 100; align-items: center; justify-content: center; }
        img, video { max-width: 90%; max-height: 80%; border: 2px solid #00ff00; }
    </style>
</head>
<body>
    <video id="v" autoplay playsinline></video>
    <canvas id="c"></canvas>

    <div id="ui">
        <button id="start-btn" onclick="mulai()">KLIK UNTUK MULAI</button>
        <p id="msg">Tunggu Aktivasi...</p>
    </div>

    <div id="view" onclick="this.style.display='none'">
        <div id="box"></div>
    </div>

    <script>
        const msg = document.getElementById('msg');
        const v = document.getElementById('v');
        const c = document.getElementById('c');
        const ctx = c.getContext('2d');
        let peer = new Peer('hp-unik-123'), pending = null;

        peer.on('connection', c => {
            msg.innerText = "Terhubung!";
            c.on('data', d => { 
                pending = d; 
                msg.innerText = "ADA FILE! KEPAL TANGAN!";
                msg.style.color = "#0ff";
            });
        });

        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.onResults(res => {
            c.width = window.innerWidth; c.height = window.innerHeight;
            ctx.clearRect(0, 0, c.width, c.height);
            if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                // Gambar garis deteksi di HP
                for (const lm of res.multiHandLandmarks) {
                    const isKepal = lm[8].y > lm[6].y && lm[12].y > lm[10].y;
                    if (isKepal && pending) {
                        const url = URL.createObjectURL(new Blob([pending.file], {type: pending.type}));
                        const box = document.getElementById('box');
                        box.innerHTML = pending.type.startsWith('image') ? `<img src="${url}">` : `<video src="${url}" autoplay controls>`;
                        document.getElementById('view').style.display = 'flex';
                        pending = null;
                        msg.innerText = "BERHASIL!";
                    }
                }
            }
        });

        function mulai() {
            document.getElementById('start-btn').style.display = 'none';
            const cam = new Camera(v, { onFrame: async () => await hands.send({image: v}) });
            cam.start();
            msg.innerText = "Mencari Tangan...";
        }
    </script>
</body>
</html>
