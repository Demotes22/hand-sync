<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand-Sync: AUTO-OPEN</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: white; text-align: center; margin: 0; overflow: hidden; }
        #input_video { display: none; }
        #output_canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.4; z-index: 1; transform: scaleX(-1); }
        
        /* Container untuk menampilkan file yang masuk */
        #preview-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; background: black; z-index: 10; 
            justify-content: center; align-items: center; 
        }
        #preview-container img, #preview-container video { max-width: 90%; max-height: 90%; border-radius: 10px; border: 3px solid #00ff00; }
        
        .ui-overlay { position: relative; z-index: 5; padding-top: 50px; }
        .badge { background: rgba(22, 27, 34, 0.8); padding: 15px; border-radius: 12px; border: 1px solid #30363d; display: inline-block; }
        #msg { font-size: 1.3em; color: #ffca28; text-shadow: 2px 2px 4px #000; }
        .btn-close { position: absolute; top: 20px; right: 20px; padding: 10px; background: red; color: white; border: none; border-radius: 5px; z-index: 11; }
    </style>
</head>
<body>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" playsinline autoplay></video>

    <div id="preview-container">
        <button class="btn-close" onclick="closePreview()">Tutup X</button>
        <div id="file-content"></div>
    </div>

    <div class="ui-overlay">
        <div class="badge">ID HP: <span id="my-id" style="color: #58a6ff;">Mencari...</span></div>
        <p id="msg">Sentuh layar untuk memulai</p>
        <div id="status-icon" style="font-size: 4em;">✋</div>
    </div>

    <script>
        const msg = document.getElementById('msg');
        const fileContent = document.getElementById('file-content');
        const previewContainer = document.getElementById('preview-container');
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        
        let peer = new Peer();
        let pendingFile = null;
        let canInteract = false;

        document.body.addEventListener('click', () => { canInteract = true; msg.innerText = "Siap Menangkap!"; }, { once: true });

        peer.on('open', id => document.getElementById('my-id').innerText = id);

        peer.on('connection', (conn) => {
            conn.on('data', (data) => {
                pendingFile = data; 
                msg.innerText = "FILE MASUK! KEPALKAN TANGAN!";
                document.getElementById('status-icon').innerText = "✊";
            });
        });

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5 });

        hands.onResults((results) => {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
                
                const isFist = landmarks[8].y > landmarks[6].y && landmarks[12].y > landmarks[10].y;

                if (isFist && pendingFile) {
                    processFile(pendingFile);
                    pendingFile = null;
                }
            }
            canvasCtx.restore();
        });

        function processFile(data) {
            // 1. Buat Blob
            const blob = new Blob([data.file]);
            const url = URL.createObjectURL(blob);
            
            // 2. Download Otomatis (Tanpa Klik)
            const a = document.createElement('a');
            a.href = url;
            a.download = data.name;
            a.click();

            // 3. Langsung Tampilkan/Buka (Jika Gambar/Video)
            fileContent.innerHTML = '';
            if (data.name.match(/\.(jpg|jpeg|png|gif)$/i)) {
                const img = document.createElement('img');
                img.src = url;
                fileContent.appendChild(img);
                previewContainer.style.display = 'flex';
            } else if (data.name.match(/\.(mp4|webm)$/i)) {
                const vid = document.createElement('video');
                vid.src = url;
                vid.autoplay = true;
                vid.controls = true;
                fileContent.appendChild(vid);
                previewContainer.style.display = 'flex';
            } else {
                msg.innerText = "File terdownload: " + data.name;
            }
        }

        function closePreview() {
            previewContainer.style.display = 'none';
            msg.innerText = "Menunggu lemparan berikutnya...";
            document.getElementById('status-icon').innerText = "✋";
        }

        new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 480, height: 640
        }).start();
    </script>
</body>
</html>
