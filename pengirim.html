<!DOCTYPE html>
<html>
<head>
    <title>Hand-Sync PENGIRIM</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #121212; color: white; text-align: center; font-family: sans-serif; }
        .box { background: #1e1e1e; padding: 15px; border-radius: 10px; display: inline-block; margin: 10px; border: 1px solid #333; }
        #output_canvas { border: 2px solid #58a6ff; border-radius: 10px; max-width: 100%; height: auto; background: #000; }
        #status-msg { color: #00ff00; font-weight: bold; margin: 10px; min-height: 20px; }
        button { padding: 10px; cursor: pointer; background: #58a6ff; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>
    <h2>ðŸ’» Mode Pengirim (Laptop)</h2>
    
    <div class="box">
        <input type="text" id="targetId" placeholder="ID HP Penerima">
        <button onclick="hubungkan()">Hubungkan ke HP</button><br><br>
        <input type="file" id="fileInput">
        <div id="status-msg">Tunggu... Sedang memuat AI</div>
    </div>

    <div style="position: relative;">
        <canvas id="output_canvas" width="640" height="480"></canvas>
        <video id="input_video" style="display:none"></video>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const statusMsg = document.getElementById('status-msg');
        
        let isHolding = false;
        let conn;
        let peer = new Peer();

        function hubungkan() {
            const id = document.getElementById('targetId').value;
            conn = peer.connect(id);
            conn.on('open', () => { statusMsg.innerText = "TERHUBUNG! Genggam di KANAN layar, geser ke KIRI."; });
        }

        // Inisialisasi AI Hands
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults((results) => {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                statusMsg.innerText = "AI AKTIF: Tangan Terdeteksi";
                for (const landmarks of results.multiHandLandmarks) {
                    // Gambar Kerangka Tangan (Garis Hijau)
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
                    drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});
                    
                    const xPos = landmarks[0].x; 
                    // Cek Mengepal: Jarak ujung jari telunjuk ke pangkalnya
                    const isFist = landmarks[8].y > landmarks[6].y && landmarks[12].y > landmarks[10].y;

                    // LOGIKA: Di monitor, KANAN adalah koordinat X Kecil (< 0.3) karena mirror
                    if (isFist && xPos > 0.7) { 
                        isHolding = true;
                        statusMsg.innerText = "âœŠ FILE DIGENGGAM!";
                        statusMsg.style.color = "yellow";
                    }
                    if (isHolding && isFist && xPos < 0.2) { 
                        if (conn && conn.open && document.getElementById('fileInput').files[0]) {
                            conn.send({ 
                                file: document.getElementById('fileInput').files[0], 
                                name: document.getElementById('fileInput').files[0].name 
                            });
                            statusMsg.innerText = "ðŸš€ WOSHH! TERKIRIM!";
                            statusMsg.style.color = "#00ff00";
                            isHolding = false;
                        }
                    }
                }
            }
            canvasCtx.restore();
        });

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        
        // Mulai kamera otomatis
        camera.start().then(() => {
            statusMsg.innerText = "Kamera Siap. Tunggu AI (5-10 detik)...";
        });
    </script>
</body>
</html>
