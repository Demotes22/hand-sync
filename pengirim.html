<!DOCTYPE html>
<html>
<head>
    <title>Pengirim - Hand Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #1a1a1a; color: white; text-align: center; font-family: sans-serif; }
        #canvas_output { position: absolute; left: 50%; transform: translateX(-50%); border: 2px solid #58a6ff; border-radius: 10px; }
        .controls { margin: 20px; padding: 15px; background: #333; display: inline-block; border-radius: 10px; }
        #log { color: #00ff00; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>ðŸ’» Mode Pengirim</h2>
    <div class="controls">
        <input type="text" id="targetId" placeholder="ID HP Penerima">
        <button onclick="hubungkan()">1. Hubungkan</button><br><br>
        <input type="file" id="fileInput">
        <div id="log">Status: Tunggu AI memuat...</div>
    </div>
    <div style="position: relative; height: 360px;">
        <video id="input_video" style="display:none"></video>
        <canvas id="canvas_output" width="480" height="360"></canvas>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('canvas_output');
        const canvasCtx = canvasElement.getContext('2d');
        const log = document.getElementById('log');
        let isHolding = false;
        let conn;
        let peer = new Peer();

        function hubungkan() {
            const id = document.getElementById('targetId').value;
            conn = peer.connect(id);
            conn.on('open', () => log.innerText = "Terhubung! Genggam di Kiri, Geser ke Kanan.");
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

        hands.onResults((results) => {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                log.innerText = "Tangan Terdeteksi!";
                for (const landmarks of results.multiHandLandmarks) {
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
                    drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});
                    
                    const xPos = landmarks[0].x; // Koordinat tangan
                    const isFist = landmarks[8].y > landmarks[6].y && landmarks[12].y > landmarks[10].y;

                    if (isFist && xPos > 0.7) { // Sisi kiri (karena mirror)
                        isHolding = true;
                        log.innerText = "FILE DIGENGGAM!";
                    }
                    if (isHolding && isFist && xPos < 0.2) { // Sisi kanan
                        if (conn && conn.open && document.getElementById('fileInput').files[0]) {
                            conn.send({ file: document.getElementById('fileInput').files[0], name: document.getElementById('fileInput').files[0].name });
                            log.innerText = "WOSH! TERKIRIM!";
                            isHolding = false;
                        }
                    }
                }
            }
            canvasCtx.restore();
        });

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 480, height: 360
        });
        camera.start();
    </script>
</body>
</html>
